/**
 * plugin.js
 *
 * Released under LGPL License.
 * Copyright (c) 1999-2015 Ephox Corp. All rights reserved
 *
 * License: http://www.tinymce.com/license
 * Contributing: http://www.tinymce.com/contributing
 */
tinymce.PluginManager.add('zotop_template', function(editor, url) {

	var template = '<div class="edt-headline-adorn ehda-42" contenteditable="false">'+
            '<div class="ehda-title" contenteditable="true" data-color="1" data-border="1"><span rel="text" data-color="1" data-not-b="1" data-fontcolor="1">zotop</span></div>'+
            '<div class="ehda-num" contenteditable="true" data-color="1" rel="text">NO.1</div>'+
        '</div>';

	editor.addButton('zotop_template', {
		title: 'zotop template',
		icon: 'template',
		onclick: function() {
			editor.insertContent(template);
		}
	});

	editor.addButton('templatalignleft', {
		title: 'template align left',
		icon: 'alignleft',		
		onclick: function() {
			var template  = getSelectedTemplate();

			if (isEditorBody(template)) {
				return;
			}			

			editor.dom.setStyle(template, 'text-align','left');
		}
	});

	editor.addButton('templataligncenter', {
		title: 'template align center',
		icon: 'aligncenter',		
		onclick: function() {
			var template  = getSelectedTemplate();

			if (isEditorBody(template)) {
				return;
			}			

			editor.dom.setStyle(template, 'text-align','center');
		}
	});

	editor.addButton('templatalignright', {
		title: 'template align right',
		icon: 'alignright',		
		onclick: function() {
			var template  = getSelectedTemplate();

			if (isEditorBody(template)) {
				return;
			}			

			editor.dom.setStyle(template, 'text-align','right');
		}
	});

	editor.addButton('templatedelete', {
		title: 'delete template',
		icon: 'tabledelete',
		onclick: function() {
			var selection = editor.selection, dom = selection.dom;
			var template  = getSelectedTemplate();
			var rng       = dom.createRng();

			if (isEditorBody(template)) {
				return;
			}			

			rng.setStartAfter(template);
			rng.setEndAfter(template);

			selection.setRng(rng);

			dom.remove(template);
		}
	});	

	function isEditorBody(node) {
		return node === editor.getBody();
	}	

	function getSelectedTemplate() {
		return editor.dom.getParent(editor.selection.getStart(), 'div.edt-headline-adorn');
	}		

	function isEditableTemplate(template) {
		var selectorMatched = editor.dom.is(template, 'div.edt-headline-adorn') && editor.getBody().contains(template);

		return selectorMatched;
	}	

	function addToolbars() {
		var toolbarItems = editor.settings.template_toolbar;

		if (toolbarItems === '' || toolbarItems === false) {
			return;
		}

		if (!toolbarItems) {
			toolbarItems = 'templatalignleft templataligncenter templatalignright templatedelete';
		}

		editor.addContextToolbar(
			isEditableTemplate,
			toolbarItems
		);
	}

	addToolbars();
});